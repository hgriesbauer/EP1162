---
title: "Manuscript_draft"
author: "Michael Jull and Hardy Griesbauer"
date: "10/12/2020"
output:
  word_document:
    reference_docx: wordTemplate2.docx
  html_document:
    df_print: paged
csl: cjfr.csl
bibliography: ep1162.bib

---

```{r load libraries for analyses, echo=FALSE, message=FALSE, warning=FALSE}

knitr::opts_chunk$set(echo = FALSE,message=FALSE,warning=FALSE)

# Load libraries
library(tidyverse)
library(lme4)
library(lmerTest)
library(broom)
library(MuMIn)
library(ggeffects)
library(car)
library(flextable)
library(captioner)
library(lsmeans)
library(cowplot)
library(officer)
library(sjPlot)
library(emmeans)

load("data/ep1162_Data.RData")
load("data/ep1162_plotData.RData")

# SOME PRELIM DATA FORMATTING
# formatting plotDat
plotDat<-
  plotDat %>% 
  mutate(Plot=as.factor(Plot))

# set up diameter classes
diamClass=seq(from=7.5,to=100,by=5)

# Set against scientific notation
options(scipen=999)


# Merge data
X<-
  dat %>% 
  left_join(plotDat,by="Plot") %>% 
  mutate(DBH.class=cut(DBH,diamClass,include.lowest=TRUE,ordered_result = TRUE,right=F,
                       labels=diamClass[1:(length(diamClass)-1)])) %>% 
  mutate(Plot=as.factor(Plot)) %>% 

  
  # replace species codes with words
  mutate(Species=recode_factor(Species,Bl="Fir",Sx="Spruce")) %>% 
  mutate(Species=fct_drop(Species)) %>% # have an extra level in here for some reason
  
  # Create TU lookup
  mutate(BA.Target=paste0("TU:",BA.Target))

# set up captions

# Code to create captions for tables
tableNums <- captioner(prefix = "Table")

# Code to create captions for figures
figNums <- captioner(prefix="Figure")

# Code to create captions for appendices
appNums <- captioner(prefix="Appendix")

# Set ggplot theme
theme_set(theme_bw())

# Define function to convert diameter (cm) to basal area (m2), and vice versa
d2ba<-function(diam) {return((diam/2/100)^2*pi)}
ba2d<-function(ba) {return(sqrt(ba/pi)*200)}

```

# To-do list

Comments from Mike - we can put text below each comment to describe how it was addressed, and then delete comments for any issues once they are resolved.

From November 6 e-mail:

Use of terminology


  *   The term "units" is used in several places, where it seems that you mean "treatments" (or treatment types, treatment unit).

  *   The use of the term "plot" or "plots" is used appropriately as far as I can see.

  *   The term "fir" is used to describe subalpine fir or 'balsam' in several parts of the text, including possibly figure and table captions. I know what species you are referring to, of course, but others, especially cursory readers, may misconstrue it. The colloquial use of 'fir" is spread across both Abies and Douglas-fir. "Balsam" as a term has well-documented ambiguities, and while Canadians tend to use balsam for Abies, Americans often call Abies "firs", as in the various species of true fir. I would recommend using Abies as the shorthand descriptor in the text and captions for subalpine fir.  It is a short word, and we have only 1 Abies species at this site. Also, my experience in the on-line-search literature world and with things like Google Scholar is that Abies is a much better and more diagnostic search word for this subject matter than fir or balsam. "Spruce-Abies" is very unambiguous as a descriptor for this forest type.

  *   Rate of change (increase, decrease) in vol, BA, and sph: In both in your stats tables and figure captions, and in the text narrative, ensure that what you are describing is clearly and accurately described as either:  (a) the incremental change in values between two measurement periods, or (b)  the difference in absolute value in certain parameters (e.g. standing volume) between two measurement periods, or between two treatments. Also, the annualized growth rate of something averaged over a measurement period (e.g. mean PBAI, like BA growth in m2/yr over a period) is different than the rate of change in a growth rate over time (e.g. is a growth rate increasing or decreasing).  I got confused a few times on this issue.


Commentary on sections and sub-sections


Section 3.1.1 BA increment from 1992 to 2019

  *   Great: Very clear and straightforward. i.e. - log-transformed treatment (initial BA) was a very statistically significant predictor of tree response across dbh classes for both Sx and Bl.
  *   Don't know what all the random effects outputs are. I am sure they are meaningful, but I just dont know what they mean.
  *   Number of observations of 510: Should ensure it is clear that only trees > 7.5 cm dbh are counted.
  *   Would be good to define the dbh class limits somewhere. In Appendix 6 table, we describe the class mid-point.
  *   For Appendix 6, I assume that the null hypothesis for the ratio is = 1.

Section 3.1.2 Mortality

  1.  I am thinking that mortality should / could be analysed as a frequency response - i.e. - expected vs actual distribution of mortality by size class and/or species. e.g. a Chi-squared or allied type of analysis. Null hypothesis is that mortality of stems is randomly distributed across different sizes and species of trees. H1 is that it is non-random.
  2.  I'd suggest that we don't compare total mortality (e.g # of stems) across treatment units, but rather frequency relative to initial number of stems (i.e. - at beginning of observation period). That way we normalize mortality rates relative to initial stem densities. Otherwise, results could be mis-leading - e.g. Control treatments could have more mortality in overall sph, simply because they have more initial stems.
  3.  ACTION ITEM FOR ME:  I need to check my original datasets and data sorting iterations to see how I handled mortality observations for the 1992 and 1994 plot remeasurements.
  4.  Note for you:  All of the mortality you've analysed and identified so far is mortality that is incremental following 92/94, so it is still solid analysis data, just with that qualification. I will clarify the 92/94 mortalilty observations for the Methods section; we did observe dead trees at these times, but these mortality pre-dated our treatments and/or first measurements. Anyway, probably not a big deal, but this needs examination and clarification to explain this. If necessary, I will quantify observations of dead trees observed on these years, because they are actually > 0.

Testing for density-dependence of mortality responses... some ideas or hypotheses..  Note that f (___) means "a function of"...

  *   MORT RATE of a size class = f (Sum of BA in that plot > than that size class).
Would assume asymmetric competition where only bigger trees exert competition on smaller trees.
  *   MORT RATE of a size class = f ( Sum of BA in that plot that is either > or < that size class).
Assumes symmetric competition where both big and small trees exert competition on their neighbors.

Caveats:   (a) our plots and tree distributions might be too spatially variable to get a reliable test of these hypotheses, and (b) BA would be the BA at the beginning of a measurement period. And (c) a tree that died of suppression would probably show reduced growth rates prior to death; but trees that had abiotic damage and mortality - e.g. - snow or wind breakage - might not. Complicated stuff !!



3.2.1  Estimating tree height from diameter


  *   Really solid stats and rationale for a single ht:dbh model. Great !
  *   What is really interesting and useful about this is that the ht:dbh relationship is seemingly statistically independent of treatment or, that is, initial density,  A very useful simplifying assumption proven for future modellers of these stands. We should highlight this in either our results or discussion.

3.2.2 Plot means

  *   See notes above about use of term "units" vs treatment (or similar).
  *   Clarify effects of treatment and/or species on growth rate vs standing vol / BA at each measurement period.
  *   A Figure 7b or equivalent could visually present changes in growth rate over time. (e.g. previous graphs we've developed)
  *   Under Observations, # 2 - the 2nd sentence needs work to edit and clarify.

3.2.3 Stand attributes by diameter class

  *   We should define what we mean by the term inverse J or inverse J-shaped dbh distribution. Just for clarity.
  *   Should we quantitatively describe these distributions? Don't have to, just asking the question.
  *   Is the merch limit for min merch tree size 18.5 cm dbh, or 17.5 cm dbh? I remember the latter from various cruises and cruise compilations.
  *   There are two Figure 2's, one is for vol and one is for sph.
  *   Clarify in figures and text that sph is based on trees 7.5 cm dbh and greater. Increases in sph can be from ingress of trees growing from size classes below this limit.
  *   A suggestion:  Have a table comparing total volume to merch volume by treatment, etc?  Would be useful for some readers, and communicate MAI and volume growth rates too.

3.2.4  Species composition


  *   First sentence:  Clarify what you mean by "organized similarly". Does this refer to frequency distribution ? What constitutes similarity?




# Introduction


# Methods

This section will describe the methods we used for data analyses, not field data collection.  

From our technical report submitted to FCI earlier:

Our data analyses and summaries examined the effects of the different levels of stand-level basal area density treatments on three main attributes of stand development following treatment. These include, in order: 
 
1. Post-treatment stand basal area dynamics, including the rate and pattern of basal area re-growth and recovery over time following different levels of initial basal area density reductions;
2. Stand structural outcomes, including treatment influences on the overall abundance of trees (in sph) by diameter class, within the different treatment types, and;
3. Tree species composition outcomes, including treatment influences on the relative abundance and size class distributions of subalpine fir and hybrid white spruce within the different treatment types. 

Analyses are grouped into three main categories (below).  These are treated as separate categories in the Results section.

1. Tree-level responses to treatment;
2. Stand-level responses to treatment:


## Tree-level growth responses

To test the hypothesis that tree-level radial growth response over the 1992-2019 period varied with interactions between (i) tree diameter at the time of treatment (1992); (ii) treatment; and (iii) species, we fit linear mixed effects models with log-transformed 1992-2019 diameter increment as the response variable, and treatment, species and log-transformed 1992 diameter as interacting fixed effects, and plot as a random intercept effect.  We also fit a similar model with the 1992-2019 diameter increment expressed as a percentage of 1992 diameter.  Plots of residuals and fit lines with orginal data were examined to evaluate model goodness of fit.  Variance explained for each model are reported using the approach described in Nakagawa et al. [-@Nakagawa2013], as implemented in the MuMIn package for R [@barton2009mumin].  

## Stand-level growth and structure

### Stand-level volume and basal area estimates
Total and merchantable volumes were estimated for trees using species- and region-specific equations [@nigh2016] based on tree height and DBH.  Consistent with forest management practices in British Columbia, we estimated volumes for trees meeting a minimum diameter utilization limit of 18.5cm DBH.  For trees lacking a tree height measurement, we estimated height by fitting a single diameter-height model developed with a linear mixed effects model, with log-transformed DBH as a fixed effect, and tree nested within plot as a random effect.  Trees with broken tops were omitted from diameter-height models. We summed tree-level estimates of volume and basal area to generate stand-level estimates for each plot. To test the hypothesis that changes in stand attributes over 27 years varied by treatment, we fit separate linear models with stand total volume, basal area, and density as response variables, and the interaction between treatment and year as the independent variable.  

### Mortality

From Mike's e-mail:

Last winter, as well as keeping reference copies of the initial “raw” dataset following data entry and related stuff, I kept copies each stage of data cleaning and prep (about 10 iterations). 

We did have “dead tree” observations in the first ~ 2 year of monitoring. The key thing to see is : if I can determine is when the trees were dead, and/or when death was initiated, and why.  
Timing of tree death and observations of causal factors of tree death in these first two years will help inform our interpretation and data handling of these observations. 

If trees were dead or moribund at the first “initial” observation or two (as soon after the logging as possible), this is – arguably -  different than mortality that occurs over time in response to the basal area treatment and/or could be considered to be density- or treatment-dependent in some way.

The 1992 data was in mid-March really early after logging, and before snowmelt (in retrospect not a great idea but we had resources available before the end of the fiscal year at the time). The 1994 data was from when the plots were re-visited under snow-free conditions. We did a thinning and sanitation culling of trees in the treatment units and PSP’s in 1994 to remove logging-damaged trees and most deciduous, to bring the units and PSP’s down to their final treatment BA. 1994 remeasurements were completed after that.

A few plots, as you know, were established in 1994 not 1992. 

Interpretive implications:

1.	The very-early observed mortality may be a result of pre-existing stand conditions not the created, treatment-induced stand conditions. “stochastic” vs potentially treatment induced. 
2.	It can be argued that trees dead at time of treatment or very soon  thereafter were never taking up growing space in the post-harvest stand, and therefore would not contribute to the initial “green” basal area going forward. 
3.	We do have 1992 data in most plots, but it was 1994 when the BA in each trmt unit and embedded PSP was finalized. 1994 is the most homogeneous start point for all PSP’s.

Regarding tree mortality in the period from 1992 to 1994 at Summit Lake EP 1162:

I reviewed our data regarding this, any relevant project records, and my own recollection of our monitoring of tree mortality during this period. Here is my train of thought, and what I have concluded on this topic:

1992 Observations and PSP establishment limitations

Trees that were dead at the time of the 1992 PSP establishment were not tagged or recorded. The rationale for this was that these trees were dead and therefore not taking up up growing space in the stands. Dead trees in 1992 would have been either snags / dead trees pre-existing the harvest, or trees fatally damaged or killed by logging activities (e.g. – trees with stems snapped and crowns broken off, no live limbs) or trees smashed to the ground by felled trees). 

Summer 1994 sanitation treatment and Fall 1994 PSP Remeasurement

EP 1162 treatment units, including the PSP area contained therein, were assessed in Spring 1994 to review stand density / basal area, and stand condition, in order to:  
a)	identify and mark-to-cut residual trees that were considered too badly scarred or damaged to constitute good growing stock for trial purposes, 
b)	where needed, to lower the initial BA closer to the target level, 
c)	to either fell or girdle birch trees, especially in the PSP’s themselves, but usually also within the TU as a whole, and 
d)	to fell any dead, dangerous, and/or moribund trees within the treatment units and PSP’s. 
Generally most if not all of these trees felled in the sanitation felling were understory or subdominant trees, and occasionally a lower codominant tree. Tagged trees felled by the sanitation felling were documented on field sheets and our Excel datasets, so we can retrieve the species and size of these trees as needed. However, sanitation-felled trees included both live, moribund, and dead trees – generally all poorer quality or vigor though.  

After felling, the felled trees were bucked to a 2 to 3 m length so as to lay these felled trees to as close to the ground as possibly, maximize decay, and minimize physical obstructions within the TU’s and PSP’s.

As a result of the sanitation felling, potentially some trees which died or were damaged between 1992 and Summer 1994 were felled without recording these mortality events and precise tree vigor beforehand. Some minor mortality occurred between 1992 and 94, but was obscured by the post-harvest sanitation treatment. 

The 1994 Remeasurement occurred in Fall 1994, with a few plot remeasurements occurring in Winter 1994/95 (i.e. no intervening growing season). 


For scientific rigour, we should not state that there was zero mortality between 1992 and 1994. Rather, I suggest, it is more accurate to state that data on tree mortalilty between 1992 and 1994 was not collected, and that the Summer 1994 sanitation felling treatment did not allow accurate documentation of tree mortality in this initial period on a retrospective basis. 

We don’t, therefore, have data on mortality between 1992 and 1994, though my recollection is that it was minor in nature. 

The difference in basal area between 1992 and 1994 is predominantly a product of the sanitation felling of some basal area, with minor natural mortality. 

Mortality occurring between Fall 1994 and Fall 1997 remeasurements was captured accurately by these two sequential remeasurements. 

“The difference in basal area between 1992 and 1994 is a result of basal area reductions through the sanitation felling of some stems and some minor natural mortality, combined with basal area increases through the growth of remaining live stems.”

A review of the various plots indicates that between 1992 and 1994, some PSP’s decreased in BA (as sanitation removals and minor mortality exceeded growth of live stems), while others increased in BA as tree growth exceeded BA removals. 


# Results

## Tree-level 

### Basal area increment from 1992-2019

```{r mixed effects model of tree growth}

# Filter only for trees that have measurements in 1992 and 2019 
treeList<- # assign variable
  X %>% 
  filter(TreeID!="New") %>% # remove new trees
  mutate(TreeID=paste(Plot,TreeID,sep="-")) %>% # create unique treeID
  filter(Species %in% c("Spruce","Fir")) %>% # filter birch and fdi out of dataset
  filter(Status=="Live") %>% # filter for live trees
  filter(Year %in% c(1992,2019)) %>% #filter for start and end dates
  group_by(TreeID) %>% 
  summarise(N=n()) %>% 
  filter(N==2) %>% #filter for trees with 5 measurements
  pull(TreeID)
  

# derive periodic increment (period diameter or basal area increment)
piDat<-
  X %>% 
  mutate(TreeID=paste(Plot,TreeID,sep="-")) %>% # create unique treeID
  filter(TreeID %in% treeList) %>% 
  mutate(BA=d2ba(DBH)) %>% # convert DBH to basal area
  dplyr::select(Plot,TreeID,Species,Year,BA) %>% 
  pivot_wider(names_from=Year,values_from=BA) %>% 
  mutate(PI=`2019`-`1992`) %>% # 
  filter(PI>0) %>% # one tree has a PI of 0, has to be removed
  mutate(PIpct=PI/`1992`*100) %>% # express periodic increment a a percentage
  dplyr::select(Plot,TreeID,Species,PBAI=PI,PBAIpct=PIpct,Init=`1992`) %>% 
  left_join(plotDat,by="Plot") 

# fit lmer model
  # fixed effects model with species pooled, using PBAI
  fitBA<-
    piDat %>% 
    lmer(log(PBAI)~BA.Target:log(Init):Species+(1|Plot),data=.)
  
  # create a reference grid for five different diameter classes (converted to BA)
  rg<-ref_grid(fitBA,at=list(Init=d2ba(c(10,20,30,40,50))),type="response",nesting=NULL)

  # Using PBAIpct
  fitBApct<-
    piDat %>% 
    lmer(log(PBAIpct)~BA.Target:log(Init):Species+(1|Plot),data=.)
  
# create a reference grid for five different diameter classes (converted to BA)
  rg.pbaipct<-ref_grid(fitBApct,at=list(Init=d2ba(c(10,20,30,40,50))),type="response",nesting=NULL)



```



```{r tree level species contrasts}

sppContrast<-
 
  pairs(rg,by=c("BA.Target","Init"),type="response") %>% 
  as.data.frame() %>%
    mutate(Init=as.numeric(as.character(Init))) %>% # change from factor to numeric
    mutate(Init=ba2d(Init)) %>% # convert basal area to diameter
  arrange(BA.Target,Init) %>% 
  rename(DBH.1992="Init") 


```


```{r treatment contrasts}

trtContrast<-
  pairs(rg,by=c("Species","Init"),type="response") %>% 
  as.data.frame() %>% 
  mutate(Init=as.numeric(as.character(Init))) %>% # change from factor to numeric
  mutate(Init=ba2d(Init)) %>% # convert basal area to diameter
  arrange(Species,contrast,Init) %>% 
  rename(DBH.1992="Init") 

```

```{r set up tree BAI references}


  figNums(name="treeBAI.plot",display=FALSE) # Estimated marginal means from Lme

  tableNums("fitBA.table",display=FALSE) # Summary of mixed effects model for BAI
  tableNums("fitBApct.table",display=FALSE) # Summary of mixed effects model for BAI
  
  appNums("sppContrast.table",display=FALSE) # Species contrasts from treeBAI model
  appNums("trtContrast.table",display=FALSE) # Treatment contracts from treeBAI model

```

The tree-level basal area increment model indicated that interactions between log-transformed tree size, species and treatment explained `r round(r.squaredGLMM(fitBA)[1]*100,1)`% (marginal R²) of the variation in log-transformed 1992-2019 tree-level BAI (`r tableNums("fitBA.table",display="cite")`).  Estimated marginal means from the model showed that between species and among treatments, larger trees increased basal area more than smaller trees (`r figNums("treeGrowth.plot",display="cite")`).  Species contrasts showed that spruce trees increased  basal area more than than fir in the high-removal treatment unit, whereas basal growth between the two species was close to equal in the low-removal and control units (`r appNums("sppContrast.table",display="cite")`).  Within each species, treatment contrasts showed that spruce basal area increment in the high-removal unit exceeded spruce growth in both other units (`r appNums("trtContrast.table",display="cite")`), whereas fir basal area increment in the high- and low-removal units was higher than the control unit, and there were no significant differences between the two harvested units (`r appNums("trtContrast.table",display="cite")`).




## Stand-level analyses

```{r height to diameter models}

# Fit model
htDiamFit<- 
  X %>% 
    filter(Species %in% c("Fir","Spruce")) %>% # filter for Bl and Sx for now
    filter(Status=="Live") %>% # filter for live trees
    filter(is.na(DBT)) %>% # filter for trees with no broken tops
    drop_na(Height) %>% # remove trees where height was not measured
  mutate(TreeID=paste(Plot,TreeID,sep="-")) %>% # create tree ID column
  lmer(log(Height)~log(DBH)+(1|Plot/TreeID),data=.)

# Apply fit model to data and create new height column
X<-
  X %>% 
  mutate(Height.Pred=coalesce(Height,exp(fixef(htDiamFit)[1]+fixef(htDiamFit)[2]*log(DBH))))

appNums("htModelFit.plot",display="FALSE") # model output

# Tree heights model
  appNums("heightDiam.plot",display=FALSE) # Plot of diameter/heights`


```


### Tree height modeling
Tree heights had a positive nonlinear relationship with diameter, for both species and across all time periods (`r appNums("heightDiam.plot",display="cite")`).  We modeled tree height using a linear mixed effects model with log-transformed diameter as the fixed effect, and tree nested within plot as a random effect.  We originally developed separate models for each species and time period, however, a comparison of height-diameter models showed that intercepts and slopes did not vary significantly (i.e., p>0.05) between species or time periods (not shown).  Therefore, we developed a single height-diameter linear mixed-effects model using `r X %>% filter(Species %in% c("Fir","Spruce")) %>% filter(Status=="Live") %>% filter(is.na(DBT)) %>% drop_na(Height) %>% nrow()` tree height-diameter observations in the dataset. This model explained `r round(MuMIn::r.squaredGLMM(htDiamFit)[1]*100,1)`% of variation in log-transformed heights, with an intercept of `r round(fixef(htDiamFit)[1],3)` and slope coefficient of  `r round(fixef(htDiamFit)[2],3)` * log-transformed DBH (not shown).  Residual and predicted vs actual height plots were assessed to ensure goodness of fit (`r appNums("htModelFit.plot",display="cite")`). Using this model, we generated height estimates for trees without height measurements, and then estimated tree total volume as per Nigh [-@nigh2016].




```{r hardcode volume coefficients per Nigh}

volCoef<-
  
  ## TOTAL VOLUME
  #  Subalpine fir 
  data.frame(Species="Fir",VolType="total",b0=-9.79,b1=1.813,b2=1.033) %>% 
  
  # Douglas-fir
  add_row(Species="Fd",VolType="total",b0=-10.19,b1=1.73,b2=1.206) %>% 
  
  # Add spruce
  add_row(Species="Spruce",VolType="total",b0=-10.024,b1= 1.801,b2= 1.107) %>% 
  
  ## MERCHANTABLE VOLUME
  # Subalpine fir
  add_row(Species="Fir",VolType="merch",b0=-9.980,b1= 1.792,b2= 1.102) %>% 
  
  # Douglas-fir
  add_row(Species="Fd",VolType="merch",b0=-10.503,b1= 1.724,b2= 1.296) %>% 
  
  # Spruce
  add_row(Species="Spruce",VolType="merch",b0=-10.280,b1= 1.769,b2= 1.206 ) %>% 
  
  mutate(BGC.Zone="SBS") %>% 
  
  # convert species to factor
  mutate(Species=factor(Species)) %>% 
  dplyr::select(Species,BGC.Zone,everything())

```

```{r summarize stand attributes by diameter class}

# We will produce diameter class stand attributes for two time periods 1992 and 2019.

standDiam.X<-
  
  # Determine which plots have measurements in 1992 and 2019
  X %>% 
   filter(Year %in% c(1992,2019)) %>% 
   filter(Status=="Live") %>% 
  
  group_by(Plot,Year) %>% 
  summarise(n=n()) %>% 
  ungroup() %>% 
  group_by(Plot) %>% 
  summarise(n=length(Year)) %>% 
  filter(n>1) %>% # pick plots with measurements in both years
  pull(Plot) %>% 
  as.data.frame() %>% 
  setNames("Plot") %>% 
  
  # Now filter original dataset 
  left_join(X,by="Plot") %>% 
  mutate(Plot=fct_drop(Plot)) %>%  # drop unused levels
  
  # Filter for years of interest
  filter(Year %in% c(1992,2019)) %>% 
  mutate(Year=fct_drop(Year)) %>% 
  filter(Status=="Live") %>% 
  
    # Calculate volume
  left_join(filter(volCoef,VolType=="total"),by="Species") %>% 
  mutate(vol=exp(1)^b0*DBH^b1*Height.Pred^b2) %>% 
  mutate(BA=d2ba(DBH)) %>% 
  dplyr::select(BA.Target,Plot:Species,Year,DBH,BA,vol,DBH.class,Height.Pred) %>% 
  mutate(Species=factor(Species)) %>% 
    
 # Now create plot-level stats
  ungroup() %>% 
  group_by(BA.Target,Plot,Species,Year,DBH.class) %>% 
  summarise(BA=sum(BA)*20,
            Vol=sum(vol)*20,
            SPH=n()*20) %>% 
  ungroup()

# Now summarize periodic diameter class stand attributes by species



# # Create total summaries
#   diamClass.total<-
#     standDiam.X %>% 
#     
#     # create plot totals first
#     group_by(BA.Target,Plot,Year,DBH.class) %>% 
#     summarise(BA=sum(BA),
#               Vol=sum(Vol),
#               SPH=sum(SPH)) %>% 
#     mutate(Species="Total") %>% 
#     ungroup() %>% 
#     
#     # now we have to complete the data frame to create BA.Target means
#     complete(nesting(BA.Target,Plot),Year,DBH.class,fill=list(BA=0,SPH=0,Vol=0)) %>% 
#     group_by(BA.Target,Year,DBH.class) %>% 
# 
#     # Plot means
#     summarise(BA=mean(BA),
#               Vol=mean(Vol),
#               SPH=mean(SPH)) %>% 
#     ungroup() %>% 
#     mutate(Species="Total") %>% 
#     filter(BA>0) %>% 
#     dplyr::select(BA.Target,Species,Year,DBH.class,BA,Vol,SPH)
  
  diamClass.spp<-
     standDiam.X %>% 
    # filter(Species %in% c("Fir","Spruce")) %>%  
    # create plot totals first
    filter(Species!="Ep") %>% # remove birch to clarify
    mutate(Species=fct_drop(Species)) %>% # drop Ep from levels
    
    # now we have to complete the data frame to create BA.Target means
    complete(nesting(BA.Target,Plot),Species,Year,DBH.class,fill=list(BA=0,SPH=0,Vol=0)) %>% 
    group_by(BA.Target,Species,Year,DBH.class) %>% 

    # Plot means
    summarise(BA=mean(BA),
              Vol=mean(Vol),
              SPH=mean(SPH)) %>% 
    ungroup() %>% 
    filter(BA>0) %>% 
    dplyr::select(BA.Target,Species,Year,DBH.class,BA,Vol,SPH) %>% 
    
    # reorder Species levels for plotting
    mutate(Species=fct_relevel(Species, "Fd", after = Inf)) %>% 
    mutate(Species=fct_recode(Species,`Douglas-fir`="Fd"))

 
```

### Plot means

```{r generate stand level plot means}

plotData.X<-
# Determine which plots have measurements in 1992 and 2019
  X %>% 

  filter(Status=="Live") %>% 
  
    # Calculate volume
  left_join(filter(volCoef,VolType=="total"),by="Species") %>% 
  mutate(vol=exp(1)^b0*DBH^b1*Height.Pred^b2) %>% 
  mutate(BA=d2ba(DBH)) %>% 
  dplyr::select(BA.Target,Plot:Species,Year,DBH,BA,vol,DBH.class,Height.Pred) %>% 
  mutate(Species=factor(Species)) %>% 
  
  # Remove volumes below 18.5cm DBH
  mutate(vol=replace(vol,DBH<18.5,0)) %>% 
  
  # now create plot sums grid so that you can calculate means
  group_by(BA.Target,Plot,Year) %>% 
    summarise(Vol.sum=sum(vol,na.rm=T)*20,
              BA.sum=sum(BA)*20,
              SPH.sum=n()*20) %>% 
              
  ungroup() %>% 
  
  # Create QMD
  mutate(QMD.mean=sqrt(BA.sum/(SPH.sum*0.0000785))) 

# Now summarise plot data at the treatment unit level
standData.X<-
  plotData.X %>% 
  group_by(BA.Target,Year) %>% 
  summarise(Vol=mean(Vol.sum),
            Vol.se=sd(Vol.sum)/sqrt(length(Vol.sum)),
            BA=mean(BA.sum),
            BA.se=sd(BA.sum)/sqrt(length(BA.sum)),
            SPH=mean(SPH.sum),
            SPH.se=sd(SPH.sum)/sqrt(length(SPH.sum)),
            QMD=mean(QMD.mean),
            QMD.se=sd(QMD.mean)/sqrt(length(QMD.mean)))



figNums("standPlots",display=FALSE)
```

```{r periodic increment by treatment level}

# Create a function to compute standard error for vectors with NA
incSE<-function(x) {
  
  x2<-
    x %>% 
    .[!is.na(.)] 
  
  
    sd(x2)/sqrt(length(x2)) %>% 
    return()
  }

perInc.X<-
  plotData.X %>% 
  pivot_longer(cols=Vol.sum:QMD.mean,names_to="var",values_to = "val") %>% 
  pivot_wider(names_from = Year,values_from = val) %>% 
  mutate(Period1=(`1994`-`1992`)/3,
         Period2=(`1997`-`1994`)/3,
         Period3=(`2009`-`1997`)/11,
         Period4=(`2019`-`2009`)/11) %>% 
  dplyr::select(BA.Target:var,Period1:Period4) %>% 
  pivot_longer(cols=Period1:Period4,names_to="Period",values_to="Values") %>% 
  pivot_wider(names_from=var,values_from=Values) %>% 
  
  # now summarize at treatment unit level
  group_by(BA.Target,Period) %>% 
   summarise(Vol=mean(Vol.sum,na.rm=T),
            Vol.se=incSE(Vol.sum),
            BA=mean(BA.sum,na.rm=T),
            BA.se=incSE(BA.sum),
            SPH=mean(SPH.sum,na.rm=T),
            SPH.se=incSE(SPH.sum),
            QMD=mean(QMD.mean,na.rm=T),
            QMD.se=incSE(QMD.mean)) %>% 
  
  # rename periods
  mutate(Period=dplyr::recode(Period,
                       Period1="1992-1994",
                       Period2="1994-1997",
                       Period3="1997-2009",
                       Period4="2009-2019")) 

# create captions for figures and table
figNums("perInc.plot",display=FALSE)
appNums("perInc.table",display=FALSE)


```


```{r fit model to plot data}

# Rename columns in plotData.X
plotData.X<-
  plotData.X %>% 
  rename(Vol="Vol.sum",
         BA="BA.sum",
         SPH="SPH.sum",
         QMD="QMD.mean")

# fit linear models
fit.vol<-lmer(Vol~BA.Target*Year+(1|Plot),data=plotData.X)
fit.ba<-lmer(BA~BA.Target*Year+(1|Plot),data=plotData.X)
fit.sph<-lmer(SPH~BA.Target*Year+(1|Plot),data=plotData.X)

# Summarize models
library(lmerTest)


# Create estimated marginal means
vol.means <- emmeans(fit.vol, ~ BA.Target*Year)
ba.means <- emmeans(fit.ba, ~ BA.Target*Year)
sph.means <- emmeans(fit.sph, ~ BA.Target*Year)

# Slope Contrasts
vol.contrast <- contrast(vol.means,interaction=c("pairwise","revpairwise"))
ba.contrast <- contrast(ba.means,interaction=c("pairwise","revpairwise")) 
sph.contrast <- contrast(sph.means,interaction=c("pairwise","revpairwise"))

# Mean contrasts
volM.contrast <- pairs(vol.means,by="Year")
baM.contrast <- pairs(ba.means,by="Year")
sphM.contrast <- pairs(sph.means,by="Year")

# CREATE TABLES

# create the data frame of ANOVA
standFit.X<-
  data.frame(Variable="Volume",anova(fit.vol, type="3")) %>% 
  rbind(data.frame(Variable="Basal area",anova(fit.ba, type="3"))) %>% 
   rbind(data.frame(Variable="Stand density",anova(fit.sph, type="3"))) %>% 
  
  # formatting
  rownames_to_column("Fixed effect") %>% 
  dplyr::select(Variable,`Fixed effect`,Sum.Sq:F.value,P.value="Pr..F.") %>% 
  mutate_at(vars("F.value","P.value"),round,5) %>% 
  mutate(`Fixed effect`=rep(c("Treatment","Year","Trt*Year"),times=3)) %>% 
  rename(`Sum sq.`="Sum.Sq",
         `Mean sq.`="Mean.Sq",
         `Num. DF`="NumDF",
         `Den. DF`="DenDF",
         `F value`="F.value",
         `p value`="P.value")

# Create slope contrasts table
standFit.contrasts<-
  data.frame(Variable="Volume",vol.contrast) %>% 
  rbind(data.frame(Variable="Basal area",ba.contrast)) %>% 
  rbind(data.frame(Variable="Stand density",sph.contrast)) %>% 
  filter(Year_revpairwise %in% c("2019 - 1992")) %>% 
  dplyr::select(Variable,`Year contrast`="Year_revpairwise",`Treatment contrast`="BA.Target_pairwise",everything()) %>% 
  rename(`t ratio`="t.ratio",
         `p value`="p.value") %>% 
  mutate_at(vars(estimate:`t ratio`),round,3) %>% 
  mutate_at(vars(`p value`),round,5)
  
# Create mean contrasts table
standFitM.contrasts<-
  data.frame(Variable="Volume",volM.contrast) %>% 
  rbind(data.frame(Variable="Basal area",baM.contrast)) %>% 
  rbind(data.frame(Variable="Stand density",sphM.contrast)) %>% 
  dplyr::select(Contrast=contrast,Variable,Year,everything())

figNums("standFit.X",display=FALSE)
appNums("standFit.contrasts",display=FALSE)  
appNums("standFitM.contrasts",display=FALSE)    


```




All units increased volume, basal area and stand density over the 1992-2019 period (`r figNums("standPlots",display="cite")`).  Mean annual basal area and volume increment peaked during the 1997-2009 period in the two harvested treatments, and peaked in the 1994-1997 period in the control treatment unit (`r figNums("perInc.plot",display="cite")`.  The low RBA unit accrued basal area significantly faster than the other two units over the 1992-2019 period (`r appNums("standFit.contrasts",display="cite")`).  The estimated rate of basal area increment in the low RBA unit from 1992 to 2019 was higher by 
`r standFit.contrasts %>% as.data.frame() %>% filter(Variable=="Basal area") %>%   pull(estimate) %>% round(.,1) %>% .[1]`
and
`r standFit.contrasts %>% as.data.frame() %>% filter(Variable=="Basal area") %>%   pull(estimate) %>% round(.,1) %>% .[2]`
m² per hectare more than the high RBA and control units, respectively (p<0.01 for both). 


The low RBA unit also significantly increased its stand density by an estimated 
`r standFit.contrasts %>% as.data.frame() %>% filter(Variable=="Stand density") %>%   pull(estimate) %>% round(.,0)  %>%   .[2]`
stems per hectare more than the control unit (p<0.001). The rate of change in tree density did not differ significantly between the two harvested units.  The rate of change in volume in trees over 18.5cm DBH was different between barely significant between the two harvested units, and there were no significant differences between the control and harvested units.  




### Stand attributes by diameter class

Among treatments and throughout the stand development after treatment, the stands maintained a negative exponential (also referred to as 'reverse-J') diameter class distribution (`r figNums("diamK.plot",display="cite")`).  
Immediately after the partial harvest, the diameter class distribution of volume differed among treatments.  In the 27 years since partial harvest, volume in all three treatment units was mostly concentrated in the 22.5-27.5cm DBH class, and mostly comprised of fir (`r figNums("diamVol.plot",display="cite")`).  Over both time periods shown in the figure and all three treatments, most of the spruce volume was concentrated in DBH classes spanning 37.5 to 47.5cm.  Basal area trends were very similar to volume (not shown).  



### Species composition

```{r generate species composition data}

sppComp.X<-
  X %>% 
  filter(Status=="Live") %>% # filter for live trees
  filter(Species %in% c("Spruce","Fir")) %>% # filter for spruce and fir trees
  
  # Compute basal area and volume
 left_join(filter(volCoef,VolType=="total"),by="Species") %>% 
  mutate(vol=exp(1)^b0*DBH^b1*Height.Pred^b2) %>% 
  mutate(BA=d2ba(DBH)) %>% 
  dplyr::select(BA.Target,Plot:Species,Year,DBH,BA,vol) %>% 
  mutate(Species=factor(Species)) %>% 
  
  # Need to add zero values for spruce in Plot 19
  add_row(BA.Target="TU:10",Plot=19,Year=c(1992,1994,1997,2009,2019),Species="Spruce",DBH=20,vol=0,BA=0) %>% 
  
  
  # Remove volumes below 18.5cm DBH
  mutate(vol=replace(vol,DBH<18.5,0)) %>%
  
  # summarise 
  group_by(BA.Target,Plot,Species,Year) %>% 
  summarise(sph=n()*20,
            BA=sum(BA)*20,
            Vol=sum(vol)*20) %>% 
  ungroup() %>% 
  
  # pivot_longer
  pivot_longer(cols=sph:Vol,names_to="Var",values_to = "Value")

plotTotal.X<-
  sppComp.X %>% 
  pivot_wider(names_from="Var",values_from = "Value") %>% 
  group_by(BA.Target,Plot,Year) %>% 
   summarise(sph=sum(sph),
            BA=sum(BA),
            Vol=sum(Vol)) %>% 
  pivot_longer(cols=sph:Vol,names_to="Var",values_to="Plot.Total") %>% 
  inner_join(sppComp.X,by=c("BA.Target","Plot","Year","Var")) %>% 
  
  # create proportion column
  mutate(Prop=Value/Plot.Total) %>% 
  ungroup() %>% 
  
  # a Few plots have no values in some years
  drop_na(Prop)

plotTotal.table<-
  plotTotal.X %>% 
  group_by(BA.Target,Year,Species,Var) %>% 
  summarise(Prop=mean(Prop,na.rm=T))


```


```{r caption for species composition plots}

figNums("sppComp.plot",display=FALSE)
figNums("sppCompDiam.plot",display=FALSE)
 
```

A comparison of proportional species composition by diameter class, treatment and year showed that fir and spruce proportion by diameter class varied similarly between the high RBA and control units (`r figNums("sppCompDiam.plot",display="cite")`).  In 1992, the largest diameter classes were dominated by spruce, whereas fir was the dominant species in the smallest diameter classes.  This pattern was found for volume, basal area, and tree density.  We only show volume in this document.  By 2019, the fir-spruce composition by distribution class was maintained in these two units, with small increases in spruce composition in the smallest diameter class.

In the low RBA, the species composition distribution by diameter class was different.  Here, both fir and spruce maintained similar proportions across diameter classes smaller than 37.5cm DBH.  Spruce formed the leading species in diameter classes above 37.5cm DBH, with the exception of the largest class.

## Mortality

```{r mortality data}

# Create dead dataset

# Dead species totals
deadList<-
  X %>% 
  filter(Status=="Dead") %>% 
  mutate(ID=paste(Plot,TreeID,sep="-")) %>% 
  group_by(ID) %>% 
  summarise_all(first)

# Summarize mortality by treatment unit
dead<-
  X %>% 
  filter(Status=="Dead") %>% 
  mutate(ID=paste(Plot,TreeID,sep="-")) %>% 
  mutate(Species=fct_recode(Species,`Douglas-fir`="Fd")) %>% 
  group_by(ID) %>% 
  summarise_all(first) %>% 
  ungroup() %>% 
  mutate(BA=d2ba(DBH)) %>% # convert to basal area per hectare 
  group_by(BA.Target,DBH.class,Year) %>% 
  summarise(BA=sum(BA),
            k=n()) 

# Summarize mortality by plot - this will be used for Figure
deadPlot.X<-
  X %>% 
  filter(Status=="Dead") %>% 
  mutate(ID=paste(Plot,TreeID,sep="-")) %>% 
  mutate(Species=fct_recode(Species,`Douglas-fir`="Fd")) %>% 
  group_by(ID) %>% 
  summarise_all(first) %>% 
  ungroup() %>% 
  mutate(BA=d2ba(DBH)) %>% # convert to basal area per hectare 
  group_by(BA.Target,Plot) %>% 
  summarise(BA=sum(BA),
            k=n()) %>% 
  full_join(plotData.X,by=c("BA.Target","Plot")) %>% 
  filter(Year==1997) %>% 
  rename("BA.dead"=BA.x,"Num.dead"=k) %>% 
  mutate(BA.dead=replace_na(BA.dead,0),
         Num.dead=replace_na(Num.dead,0)) %>% 
  mutate(prop.K=Num.dead/SPH,
         prop.BA=BA.dead/BA.y)

# linear model to analyze mortality by plot volume
deadPlot.ANOVA<-
  lm(Num.dead~Vol,data=deadPlot.X) 

dead.Summ<-
  dead %>% 
  ungroup() %>% 
  group_by(BA.Target) %>% 
  summarise(BA=sum(BA)/sum(dead$BA)*100,
            k=sum(k)/sum(dead$k)*100) %>% 
  mutate_if(is.numeric,round,1)





figNums("mort.plot",display=FALSE)
figNums("mortDiam.plot",display=FALSE)

```

A total of `r deadList %>% nrow()` trees (`r deadList %>% filter(Species=="Fir") %>% nrow()` fir, `r deadList %>% filter(Species=="Spruce") %>% nrow()` spruce, and `r deadList %>% filter(Species=="Fd") %>% nrow()` Douglas-fir) died in `r length(unique(deadList$Plot))` plots from 1997 to 2019. By treatment unit, the control unit had the highest mortality, in terms of trees and basal area (
`r dead.Summ %>% filter(BA.Target=="TU:Control") %>% pull("k")` and 
`r dead.Summ %>% filter(BA.Target=="TU:Control") %>% pull("BA")`% of tree mortality, respectively).  The high-removal treatment unit had the lowest mortality by number of trees and basal area (
`r dead.Summ %>% filter(BA.Target=="TU:10") %>% pull("k")` and 
`r dead.Summ %>% filter(BA.Target=="TU:10") %>% pull("BA")`% of tree mortality, respectively).  Tree mortality was concentrated in the smaller diameter classes in the control and low-removal treatment unit, and most mortality occured during the most recent measurement period of 2009-2019 (
`r figNums("mort.plot",display="cite")`).











# Discussion

## Species differences in growth response to partial harvest

At the tree-level, our results suggest that while both species respond to thinning with faster radial growth, heavy thinning can elicit a stronger radial growth response in spruce, compared to fir.  This coincides with our finding of proportionally higher spruce volume and basal area in the heavy thinning treatment in 2019, compared to the other treatments.  Where thinning treatments in this region retain both spruce and fir, high-removal treatments may favour spruce release.  Other studies have shown that residual spruce growth responds favourably to heavy thinning.  A 10-year analysis of white spruce growth underneath an aspen canopy found that a complete overstory removal and heavy basal area removal resulted in immediate and significant spruce radial and height growth responses, compared to control and partial cutting treatments (Smith et al. 2016).   In a 35-year old white spruce stand, diameter increment was maximized with the heaviest thinning intensity, however, the treatment in this study was thinning from below (Stiell 1970).  Frank (1973) also showed that 70-year old white spruce basal increment increased with the amount of thinning. Competition for light is a key factor that limits white spruce growth, and opening up the stand to allow for increased light penetration enhances white spruce growth responses [@Lieffers1994].  High basal area removal may also increase stand air and soil temperatures, which might preferentially favour spruce growth responses compared to fir (Lacjcerowicz et al. 2004).

Other comparative studies of spruce and fir growth rates present differing evidence regarding species differences in release potential to thinning.  In mature Engelmann spruce (Picea engelmannii) – subalpine fir forests in western North America, understory spruce growth rates exceeded those of fir, allowing spruce to achieve canopy position faster, including after canopy gaps were created through disturbance (Antos et al. 2000, Andrus et al. 2018).  In mature forest in central BC, spruce growth exceeded that of subalpine fir after age 80 (Eis and Craigdallie 1983).  Because spruce tends to live longer than subalpine fir, higher growth rates at later ages may allow this species to become larger than fir.  In contrast, thinning studies in spruce-fir forests in eastern North America report that balsam fir (Abies balsamifera) responds to release with faster height and diameter growth than co-occurring red spruce (Picea rubens) (Dumais and Prevost, 2007; Dumais et al. 2014, Messier et al. 1999). Although both species are similar in shade tolerance, firs are considered to be better adapted to low light conditions in the understory, allowing them to persist longer in undisturbed forest  (Antos 2000) and potentially able to respond faster to changes in understory light (Dumais et al 2014, Messier et al. 1999).  Other studies have found no difference in growth response between spruce and fir species after treatment (MCaughey and Smith1982).   Our study also suggests that at lower levels of basal area removal, spruce and fir growth responses will be similar.


## Management considerations
1. Both species responded with increased growth after partial harvest.  High removal of basal area in these forests stimulated stronger spruce growth.  This information can help silviculturists manipulate stand structure to preferentially ...
2. Partial harvesting at both intensities delayed peak volume and basal area increment by approximately 10 years.  Annual increment in the control unit declined faster over the last measurement period compared to previous periods, perhaps suggesting that the stand is becoming mature and losses due to mortality may substantially offset growth increment.

\newpage

# Tables

`r tableNums("fitBA.table",caption="Summary of mixed effects model of tree-level basal area increment")`
  
```{r summarize tree level BAI model}


```

\newpage


`r tableNums("fitBApct.table",caption="Summary of mixed effects model of tree-level basal area increment as percentage of initial tree size")`
  
```{r summarize tree level BAI as percentage model}


```

\newpage

`r tableNums("standFit.X",caption="Output from three separate linear models testing the effect of the interaction between treatment and year on plot-level volume, basal area and density." )`

```{r stand variable model output}

standFit.X %>% 
  flextable() %>% 
  align(align="left",part="all") %>% 
  merge_v(j="Variable") %>% 
  valign(valign="top",part="body") %>% 
    hline(i=c(3,6,9),border=fp_border(color="black")) %>% 
    fix_border_issues() %>% 
  autofit()
```
*Trt, treatment; Sq., squares, Num., numerator; Den., denominator; DF, degrees of freedom*

\newpage

# Figures


```{r tree BAI by treatment species and diameter class}


# Create plot of periodic increment
  
# Using estimated marginal means
  emmeans(rg,~Init|BA.Target+Species,type="response") %>% 
  as.data.frame() %>%
  mutate(Init=ba2d(Init)) %>% # convert initial basal area back to diameter
  
  # plotting
  ggplot()+
  aes(x=Init,y=response,fill=Species,color=Species)+
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=response-SE, ymax=response+SE), width=.2,
                 position=position_dodge(0.05))+
  xlab("1992 DBH (cm)")+
  ylab("Basal area increment from 1992-2019 (m²)")+
  facet_wrap(~BA.Target)


```


`r figNums("treeBAI.plot",caption="Estimated marginal means of spruce and fir basal area increment (m²) across five inital DBH classes and three treatments.  Whiskers are standard error of the mean.  Responses are back-transformed from the model.")`


\newpage


```{r function to create figure of plot means, fig.height=10}

# Plotting

# Create function
standPlot<-function(standVar,y.label) {

    standData.X %>% 
    mutate(Year=as.numeric(as.character(Year))) %>% 
    dplyr::select(BA.Target,Year,standVar,paste0(standVar,".se")) %>% 
    setNames(c("BA.Target","Year","Mean","SE")) %>% 
  
    ggplot(aes(x=Year,y=Mean,color=BA.Target,group=BA.Target))+
    geom_point()+
    geom_line()+
    geom_errorbar(aes(ymin=Mean-SE, ymax=Mean+SE, width=.2),
                   position=position_dodge(.9))+
    facet_wrap(~BA.Target)+
      scale_x_continuous(limits=c(1992,2019),breaks=c(1992,1994,1997,2009,2019),
                     minor_breaks = c(1992,1994,1997,2009,2019),
                     name="Measurement year")+ # stretch out x-axis
  theme(axis.text.x = element_text(angle = 90, hjust = 1,vjust=0.5),
        legend.position = "none")+
    ylab(y.label)

}
    
standVol.plot<-
  standPlot("Vol",y.label="Vol. (m³/ha)")+
  theme(axis.text.x=element_blank(),axis.title.x=element_blank())
  
standBA.plot<-
  standPlot("BA",y.label="BA (m²/ha)")+
  theme(axis.text.x=element_blank(),axis.title.x=element_blank())
  
standK.plot<-
  standPlot("SPH",y.label="Tree dens. (sph)")
  
standQMD.plot<-standPlot("QMD",y.label="QMD (cm)") 

standPlots<-cowplot::plot_grid(standVol.plot,standBA.plot,standK.plot,ncol=1,
                      align="v")

# display plot
standPlots
```

`r figNums("standPlots",caption="Mean plot attributes by treatment unit and year.  Whiskers are one standard error of the mean.  Vol., volume; BA, basal area; Tree dens., tree density")`

\newpage
 

```{r plot periodic increment}

# Note this function performs the operation for basal area and volume only

  
  perInc.X %>%
  dplyr::select(BA.Target:BA.se) %>% 
    setNames(c("BA.Target","Period","Vol_mean","Vol_SE","BA_mean","BA_SE")) %>% 
    pivot_longer(cols=-c(BA.Target,Period),
                 names_to=c("Var","SE"),
                 names_sep="_",
                 values_to="Value") %>% 
    pivot_wider(names_from="SE",values_from="Value") %>% 
  
  ggplot(aes(x=Period,y=mean,group=BA.Target,color=BA.Target))+
  geom_point()+
  geom_line()+
   
     geom_errorbar(aes(ymin=mean-SE, ymax=mean+SE, width=.2),
                   position=position_dodge(0))+
    facet_wrap(~Var,nrow=2,
               scales="free_y", strip.position = "left",
               labeller=as_labeller(c(BA="Basal area inc. (m²/ha/year)",Vol="Volume inc. (m³/ha/year)")))+
    ylab(NULL)+
     theme(strip.background = element_blank(),
           strip.placement = "outside")
  

```

`r figNums("perInc.plot",caption="Mean plot annual increment over four measurement periods for basal area and volume, by treatment.  Whiskers are one standard error of the mean. Inc, increment.")`

\newpage

```{r plot species composition by attribute}

plotTotal.table %>%
  mutate(Var=fct_relevel(Var,"BA","Vol","sph")) %>% 
  mutate(Var=dplyr::recode(Var,BA="Basal area",
                    Vol="Volume",
                    sph="Tree density")) %>%
  
  ggplot()+
  aes(x=Year,y=Prop,fill=Species)+
  ylab("Proportion")+
   geom_bar(position="fill",stat="identity")+
   geom_hline(yintercept=0.5, linetype="dashed", color = "black")+
  theme(legend.position = "bottom")+
  facet_grid(Var~BA.Target)



```

`r figNums("sppComp.plot",caption="Mean proportion of spruce and fir basal area, volume, and tree density by treatment and year.")`

```{r plot species composition by diameter class}

# Create plotting function  

diamClass.plot<-function(standVar,y.label) {
diamClass.spp %>% 
   ggplot()+
  geom_bar(aes(x=DBH.class,y=get(standVar),group=Species,fill=Species),stat="identity")+
  # geom_point(data=filter(diamClass.spp,Species=="Total"),
  #              aes(x=DBH.class,y=get(standVar)))+
  #   geom_line(data=filter(diamClass.spp,Species=="Total"),
  #              aes(x=DBH.class,y=get(standVar),group=Species))+  
   scale_fill_manual(values=c("#F8766D", "#00BFCA","azure4")) +  # control color
     theme(axis.text.x = element_text(angle = 90, hjust = 1,vjust=0.5),
        legend.position = "bottom")+
    ylab(y.label)+
    xlab("DBH class (cm)")+
 
    # coord_flip()+
    facet_grid(Year~BA.Target) %>% 
    return()
}
  
# create stand-level plots by diameter distribution
diamVol.plot<-diamClass.plot("Vol",y.label="Mean plot volume (m³/ha)")
diamBA.plot<-diamClass.plot("BA",y.label="Mean plot basal area (m²/ha)")  
diamK.plot<-diamClass.plot("SPH",y.label="Mean plot tree density (sph)") 
  
# diamClass.plot<-cowplot::plot_grid(diamVol.plot,diamBA.plot,diamK.plot,ncol=1)
```


```{r show volume by diameter class}
diamVol.plot


```

`r figNums("diamVol.plot",caption="Diameter-class distribution of volume (m³/hectare) by species, treatment and year.")`

*Note that in this figure, we show volume for all diameter classes.  This is different than the stand-level estimate of volume, where we only estimate volume for trees that would be considered merchantable under conventional harvest in British Columbia (i.e., minimum 18.5cm DBH).*

\newpage


```{r show tree density by diameter class}
diamK.plot


```

`r figNums("diamK.plot",caption="Diameter-class distribution of tree density (stems/hectare) by species, treatment and year.")`



\newpage

```{r species composition plots by diameter class}

sppComp.plot<-function(standVar){
  
    diamClass.spp %>% 
    filter(Species %in% c("Fir","Spruce")) %>% 
    dplyr::select(BA.Target,Species,Year,DBH.class,standVar=standVar) %>% # select columns
    pivot_wider(names_from="Species",values_from="standVar") %>%
    mutate(Fir=replace_na(Fir,0),
           Spruce=replace_na(Spruce,0)) %>% 
  
    mutate(Total=Fir+Spruce) %>% 
    mutate(Fir.prop=Fir/Total) %>% 
    mutate(Spruce.prop=Spruce/Total) %>% 
    
    mutate(Fir.prop=replace_na(Fir.prop,0),
           Spruce.prop=replace_na(Spruce.prop,0)) %>% 
    mutate(Spruce.prop=-Spruce.prop) %>% # change to neg value for plotting
    dplyr::select(BA.Target,Year,DBH.class,Spruce.prop,Fir.prop) %>% 
    pivot_longer(cols=contains(".prop"),names_to="Species",values_to="Prop") %>% 
    mutate(Species=str_remove(Species,".prop")) %>% 
    filter(Prop!=0) %>% 
    
    ggplot()+
    aes(x=DBH.class,y=Prop,group=Species,fill=Species)+
      geom_bar(stat="identity")+
    xlab("DBH class (cm)")+
    scale_y_continuous(breaks=c(-1,-0.5,0,0.5,1),
                       labels=c(1,0.5,0,0.5,1))+
    ylab("Proportion")+
    coord_flip()+
    facet_grid(Year~BA.Target) %>% 
    return()
} # end function

# create stand-level plots by diameter distribution
sppComp.plot("BA")



```


\newpage

`r figNums("sppCompDiam.plot",caption="Spruce-fir volume proportional composition by diameter class, treatment and year.")`

*Note this figure is almost identical for compairsons of basal area, volume or tree density. For brevity, we only show basal area.*

\newpage

```{r plot mortality as a function of 1997 stand attributes}

deadPlot.X %>% 
  ggplot()+
  aes(x=Vol,y=Num.dead,color=BA.Target,shape=BA.Target)+
  geom_point(size=4)+
  stat_smooth(method = lm, formula = y ~ x,se=FALSE,aes(group=1))+
  ylab("Tree mortality from 1997-2019")+
  xlab("Plot 1997 volume (m³/hectare) ")+
  theme(legend.position = "bottom")



```


```{r plot mortality by treatment}



dead %>% 
  pivot_longer(cols=BA:k,names_to = "Var",values_to = "Value") %>% 
  
  
  
  mutate(Var=factor(Var)) %>% 
  mutate(Var=fct_relevel(Var,"k","BA")) %>% 
  
  
  
  mutate(Var=dplyr::recode(Var,BA="Basal area (m²)",k="Number of trees")) %>% 
  ggplot()+
  aes(x=DBH.class,y=Value,fill=Year)+
  geom_bar(stat="identity")+
  facet_grid(Var~BA.Target,
               scales="free_y",
               switch="y")+
    ylab(NULL)+
  xlab("DBH class (cm)")+
     theme( strip.placement = "outside",
            strip.background.y = element_blank(),
            legend.position = "bottom",
            axis.text.x = element_text(angle=270,vjust = 0.3))
  


```


`r figNums("mort.plot",caption="Total tree mortality recorded in plots from 1997-2019, presented as number of trees (top panel) and basal area (bottom panel).")`

\newpage


```{r plot mortality by year and DBH class}

dead %>% 
  pivot_longer(cols=BA:k,names_to = "Var",values_to = "Value") %>% 
  mutate(Var=factor(Var)) %>% 
  mutate(Var=fct_relevel(Var,"k","BA")) %>% 
  mutate(Var=dplyr::recode(Var,BA="Basal area (m²)",k="Number of trees")) %>% 
  ggplot()+
  aes(x=DBH.class,y=Value,fill=Year)+
  geom_bar(stat="identity")+
  facet_grid(Var~BA.Target,
               scales="free_y",
               switch="y")+
    ylab(NULL)+
  xlab("DBH class (cm)")+
     theme( strip.placement = "outside",
            strip.background.y = element_blank(),
            legend.position = "bottom",
            axis.text.x = element_text(angle=270,vjust = 0.3))
  


```

`r figNums("mortDiam.plot",caption="Total tree mortality recorded in plots from 1997-2019, presented as number of trees (top panel) and basal area (bottom panel).")`


# Appendices

`r appNums("paiTable",caption="Number of growing seasons between measurement periods")`

```{r show paiTable, ft.align="left"}

  tibble(`Measurement Year`=c(1992,1994,1997,2009,2019),`Growing Seasons`=c(NA,3,3,11,11)) %>% 
  flextable() %>% 
  align(align="left",part="all") %>% 
  # set_caption(caption="Number of growing seasons between measurement periods") %>% 
  autofit()

```

\newpage


`r appNums("sppContrast.table",caption="Contrasts between predicted fir and spruce growth across treatment units and initial diameter classes.  Ratio between predicted fir and growth is in 'ratio' column.")`

```{r treelevel species contrast table}

# Tree-level species contrast table
  sppContrast %>% 
  
  mutate_if(is.double,round,5) %>%  # round to five digits

  # format table
  flextable(col_keys = c(colnames(.)[c(1:2,6:8,3:5)])) %>% 
  align(align="left",part = "all") %>% 
  vline( border = fp_border(color="#2c3a51" , width = 1), part = "all" ) %>% 
  hline( border = fp_border(color="#2c3a51" , width = 1), part = "all" ) %>% 
  merge_v(j=c(1:2,6:8)) %>% 
  valign(valign="top") %>%
 border_outer(part="all", border = fp_border(color="#2c3a51" , width = 2)) %>% 
   fix_border_issues()  # border(border.bottom = fp_border(color="black"))


```

\newpage

`r appNums("trtContrast.table",caption="Contrasts of predicted 1992-2019 tree growth among treatments within each species.  Ratio of predicted growth between treatments is in 'ratio' column.")`

```{r tree level treatment contrasts}

# Treatment contrast

trtContrast %>% 

  mutate_if(is.double,round,5) %>% 
  
  # flextable
  flextable(col_keys = c(colnames(.)[c(2,1,6:8,3:5)])) %>% 
  border_outer(part="all", border = fp_border(color="#2c3a51" , width = 2)) %>% 
  align(align="left",part = "all") %>% 
  vline( border = fp_border(color="#2c3a51" , width = 1), part = "all" ) %>% 
  hline( border = fp_border(color="#2c3a51" , width = 1), part = "all" ) %>% 
  merge_v(j=c(1:2,6:8)) %>% 
  valign(valign="top") %>%
  hline_bottom() %>% 
  fix_border_issues() # border(border.bottom = fp_border(color="black"))


```

\newpage


```{r height to diameter plot}


  X %>% 
    filter(Species %in% c("Fir","Spruce")) %>% # filter for Bl and Sx for now
    filter(Status=="Live") %>% # filter for live trees
    filter(is.na(DBT)) %>% # filter for trees with no broken tops
    drop_na(Height) %>% # remove trees where height was not measured
    
    # Plotting
  ggplot()+
  aes(x=DBH,y=Height,fill=Species)+
  geom_point()+
  facet_grid(Year~Species)+
  theme(legend.position = "none")+
  ylab("Height (m)")+
  xlab("DBH (cm)")+
  geom_smooth(formula = y~log(x),method="lm",se=FALSE)

```

`r appNums("heightDiam.plot",caption="Relationship between height (m) and diameter (cm) for ")`

\newpage

```{r height model fit}

# Height model fit plot

  X %>% 
  filter(is.na(DBT)) %>% # filter for trees with no broken tops
  mutate(h2=exp(fixef(htDiamFit)[1]+fixef(htDiamFit)[2]*log(DBH))) %>% 
  ggplot(aes(x=Height,y=h2))+
  geom_point()+
  xlim(0,40)+
  ylim(0,40)+
  geom_smooth(method="lm",se=F)+
  ylab("Predicted height (m) from diameter-height model")+
  xlab("Measured height (m)")

```


`r appNums("htModelFit.plot",caption="Scatterplot of predicted height(m) vs actual height(m) from diameter-height model.")`

\newpage

`r appNums("standFitM.contrasts",caption="Contrasts of stand attributes (volume, basal area and tree density) between treatments.  Contrasts are presented for five measurement years. SE, standard error, df, degrees freedom")`

```{r table contrasts between plot means}

standFitM.contrasts %>% 
  arrange(Contrast,Variable,Year) %>% 
  mutate_if(is.numeric,round,5) %>% 
  
  flextable() %>% 
   align(align="left",part="all") %>% 
  merge_v(j=c("Contrast","Variable","Year")) %>% 
  valign(valign="top",part="body") %>% 
    hline(i=seq(from=5,to=40,by=5),border=fp_border(color="black")) %>% 
    fix_border_issues() %>% 
  autofit()

```

\newpage

`r appNums("standFit.contrasts",caption="Contrasts of 1992-2019 stand structure development over 1992-2019 between treatments.  Contrasts are shown for three variables: volume, basal area and stand density.")`

```{r show contrasts between plot means}

standFit.contrasts %>% 
  dplyr::select(-`Year contrast`) %>% 
  flextable() %>% 
   align(align="left",part="all") %>% 
  merge_v(j=c("Variable")) %>% 
  valign(valign="top",part="body") %>% 
    hline(i=c(3,6,9),border=fp_border(color="black")) %>% 
    fix_border_issues() %>% 
  autofit()

```

\newpage



# References

