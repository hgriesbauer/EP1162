---
title: "Height estimates from DBH:Height relationship"
author: "Hardy Griesbauer"
date: "20/03/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Libraries
library(tidyverse)
library(here)


# Load data
load(here("data","ep1162_Data.RData"))


```

## Estimating tree heights based on dbh:height relationships
In order to estimate stand-level volumes for each treatment, we need to first estimate heights for trees that do not have height measurements.  We will do the following:

1. Model DBH:Height relationships separately for each measurement period, and for Bl:Sx separately (at first).
2. Compare Bl and Sx relationships, compare estimates between years, and determine if we can pool species and/or years to estimate Height.

### Step 1: Explore height:dbh relationships with scatterplots
First, let's explore scatterplots for each species and measurement year:

```{r dbh:height scatterplots,fig.height=12, fig.width=10}

  dat %>% 
    filter(Species %in% c("Bl","Sx")) %>% # filter for Bl and Sx for now
    filter(Status=="Live") %>% 
    drop_na(Height) %>% # remove trees where height was not measured
    
    # Plotting
  ggplot()+
  aes(x=DBH,y=Height,fill=Species)+
  geom_point()+
  facet_wrap(Year~Species,ncol=2)+
  theme(legend.position = "none")+
  ylab("Height (m)")+
  xlab("DBH (cm)")+
  geom_smooth(formula = y~log(x),method="lm",se=FALSE)

```

It looks like there are differences between measurement years.  There may be subtle differences between species within a measurement year.  Let's explore that now by superposing Bl and Sx graphs within same year:

```{r dbh:height scatterplots species superposed,fig.height=12, fig.width=10}

  dat %>% 
    filter(Species %in% c("Bl","Sx")) %>% # filter for Bl and Sx for now
    filter(Status=="Live") %>% 
    drop_na(Height) %>% # remove trees where height was not measured
    
    # Plotting
  ggplot()+
  aes(x=DBH,y=Height,color=Species)+
  geom_point()+
  facet_wrap(~Year)+
  theme(legend.position = "bottom")+
  ylab("Height (m)")+
  xlab("DBH (cm)")+
  geom_smooth(formula = y~log(x),method="lm",se=FALSE)

```

We can see subtle differences between Bl and Sx DBH:Height relationships in first three measurement periods.  By 2019, it looks like DBH:height relationships converged between the species.

***

Let's look at differences between years by superposing different year graphs for species separately:

```{r dbh:height scatterplots years superposed,fig.height=12, fig.width=10}

  dat %>% 
    filter(Species %in% c("Bl","Sx")) %>% # filter for Bl and Sx for now
    filter(Status=="Live") %>% 
    drop_na(Height) %>% # remove trees where height was not measured
    
    # Plotting
  ggplot()+
  aes(x=DBH,y=Height,color=Year)+
  geom_point()+
  facet_wrap(~Species,ncol=2)+
  theme(legend.position = "bottom")+
  ylab("Height (m)")+
  xlab("DBH (cm)")+
  geom_smooth(formula = y~log(x),method="lm",se=FALSE)

```

Looks like Bl maintained the same DBH:Height relationship over all measurement periods.  Sx 2019 relationship differs from other time periods.

As per previous discussion, we shouldn't pool measurements across measurement years because this would violate assumption of independence among samples.

****
### Can we pool species?  

I believe we can test this statistically:

*Note: I will get Peter Ott to confirm this is the correct way to test regression models between groups*

```{r test for species effect}

# function to compare three models
# separate models will be fit for each year

speciesMod1<-function(year) {

# Assign data
x<-
   dat %>% 
    filter(Species %in% c("Bl","Sx")) %>% # filter for Bl and Sx for now
    filter(Status=="Live") %>% 
  filter(Year==year) %>% 
    drop_na(Height) # remove trees where height was not measured

# fit a model with all terms
mod.full<-lm(Height~log(DBH)+log(DBH):Species,data=x)

# fit model with only DBH terms
mod.dbh<-lm(Height~log(DBH),data=x)

# extract coef and other values
out<-data.frame(year=year,intercept=coef(mod.dbh)[1],
                slope=coef(mod.dbh)[2],
                p.value=broom::glance(mod.dbh)$p.value,
                r2=broom::glance(mod.dbh)[1])
rownames(out)=year

# Return
return(list(anov=anova(mod.full,mod.dbh),out=out))

}


```

Now let's run the model for the four measurement periods:

1992:
```{r}
speciesMod1(1992)$anov
```

***
1994:

```{r}
speciesMod1(1994)$anov
```

***
1997:

```{r}
speciesMod1(1997)$anov
```

***
2019:

```{r}
speciesMod1(2019)$anov
```

For each of the four measurement periods, there is no significant difference between models that include DBH:species interactions and just use DBH alone.  Therefore, we can develop a single height model for each measurement period.


***

### DBH:Height equation for pooled species data


```{r dbh:height equation}

rbind(speciesMod1(1992)$out,
      speciesMod1(1994)$out,
      speciesMod1(1997)$out,
      speciesMod1(2019)$out) %>% 
  as_tibble()

      

```

Here are the coefficients from Mike's analysis:

*Subalpine fir*
HT = 11.188 x ln(DBH)  - 17.609

*Hybrid white spruce*
HT = 11.79 x ln(DBH)  - 19.637


